- 再帰呼び出しやdo/while相当の処理はloopモジュールのマクロを通じてのみ行う。
    - loopすらもimportしないとできない
    - 有限の集合に対するfor inは使用できる
- 別言語埋め込みとコメントのためにhere documentみたいな機能はやっぱ欲しいかも
- Node.jsのREPLは使いにくい。`const`で宣言した変数が再度宣言できなかったり、reloadできなかったり
    - `const`の書き換えさえできればreloadはできる？

- 理想
    - コピペで作るようなコードでも綺麗に管理できる世界を作りたい
        - <https://twitter.com/sesere115/status/1535822361316184065>
            - > 優秀な人は技術に対して真摯だからハードルを上げる方向に圧力をかけがちなんですが、プログラム10年書いてる僕はDockerほぼコピペだし、jsも半分以上コピペだし、そもそもgemとか究極のコピペだし 「動きゃいいんだよ動きゃ」の精神で全然いいと思いますけどね 誰しも上を目指したい訳じゃないですし

# 細かい設計

- shadowingについて:
    - トップレベル・importしたもののshadowingは禁止する？
    - あるいはimportしたもののみ？
- 変数いじる系のform, どうしようかなぁ。
    - `const`, `let`, `assign` で行こう。`shadow`もほしいっちゃ欲しいんだけど、とりあえず後回しで
- `if`など文と式の仕様
    - 条件節はTrue/Falseのみ（assertions実装時に実装）
    - できれば三項演算子を出力したい: 要らんこと考えずに三項演算子を出力すればいい？
        - blockの文脈では`if`を出す、が理想だけど
        - 当面は、式としての`if`は三項演算子で、文として`True`の場合だけのものを`ifThen`として提供しよう
            - 文としてだけ使えるマクロと、式として使えるマクロを区別しような
                - 文
                    - [x] `let`, `const`, `return`
                    - まだ実装しない: `break`, `continue`
                - 文を受け取る文
                    - [x] `when`
                    - まだ実装しない: `for`, `while`
                - 文を受け取る式（最後の文は式でないとならない）
                    - [x] `scope`, `fn`
                - 文を受け取る式（最後の文は式でなくてよい）
                    - [x] `procedure`: 戻り値のない関数
                - 式: それ以外（もろもろ。`if`など）
- 二項演算子系マクロ:
    - `calcF`だけじゃなくて`cmp`もいるか
- 再帰呼び出し
    - 恐らくこうすればうまく行く解決策
        - `recursive`外の場合、
            1. 識別子を参照したとき、参照先の識別子の場所をメモ
                - 未定義であればエラー
            2. 前のステップでメモした関数と同じidentifierを`const`で定義するとき、エラーにする
                - `EnvF.set`がエラーを出すように修正してみたが、まだテスト結果が変わらない...
                    - どうやら`EnvF.set`しているときの`env[0]`でチェックしている時点では、関数の定義が終了してしまっているので、すでに問題のscopeは`EnvF.pop`されてしまっているようだ
                        - だから解決するには、スコープの定義が終わった時に、`env[0]`を捨てるのではなく、積み上げて外にいる`const`に教えてあげる必要がある
                            - その場合積んでいったスコープはどこで破棄すればよいのか
                                - どこで何を参照したか、ってどの道重要な情報だろうし破棄とか考えなくていいかな。位置情報は、参照している関数の名前のパスで！
                                - 2022/11/04: 変数の定義位置について。変数自身もindexで管理しようと思ったけど、変数と番号のmappingが必要になっちゃうし、やっぱりスコープはスコープのindexで管理して、変数は名前で管理しよう
        - `recursive`内の場合、内部の`const`を従来通り当該スコープにおける`RecursiveConst`として扱う？

# TODO

- [ ] `evalBlock`において、余分な閉じカッコがあっても構文エラーにならない
- [ ] `debug`マクロも作ろう: `(console.log(x), x)`
- [ ] `error`マクロも作ろう: `(() => throw error)()`
- [ ] `if`など、文を受け取らないformで`isNonExpressionCall`なformを使ったときのエラー
    - `incrementF`とかが危ない
- [ ] `break`, `continue`が使える箇所のvalidation, test
- [ ] `comment`マクロ: 空のソースコードを出力。`null`も返さない
